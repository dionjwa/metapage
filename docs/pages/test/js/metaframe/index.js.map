{"version":3,"sources":["../../node_modules/eventemitter3/index.js","v0_4/versions.ts","v0_4/core.ts","v0_4/events.ts","v0_4/jsonrpc.ts","v0_4/metapage.ts","v0_4/index.ts","Constants.ts","../../node_modules/compare-versions/index.js","Shared.ts","MetapageTools.ts","Metaframe.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;AC7UA,IAAY,iBAAZ;;;AAAA,CAAA,UAAY,iBAAZ,EAA6B;AAC5B,EAAA,iBAAA,CAAA,MAAA,CAAA,GAAA,KAAA;AACA,EAAA,iBAAA,CAAA,MAAA,CAAA,GAAA,KAAA;AACA,CAHD,EAAY,iBAAiB,iCAAjB,iBAAiB,GAAA,EAAA,CAA7B;;AAKA,IAAY,gBAAZ;;;AAAA,CAAA,UAAY,gBAAZ,EAA4B;AAC3B,EAAA,gBAAA,CAAA,MAAA,CAAA,GAAA,KAAA;AACA,EAAA,gBAAA,CAAA,MAAA,CAAA,GAAA,KAAA;AACA,CAHD,EAAY,gBAAgB,gCAAhB,gBAAgB,GAAA,EAAA,CAA5B;;AAKO,MAAM,oBAAoB,GAAG,MAAM,CAAC,IAAP,CAAY,iBAAZ,CAA7B;;AAEA,MAAM,uBAAuB,GAAG,iBAAiB,CAAC,IAAlD;;AAEA,MAAM,mBAAmB,GAAG,MAAM,CAAC,IAAP,CAAY,gBAAZ,CAA5B;;AAEA,MAAM,sBAAsB,GAAG,gBAAgB,CAAC,IAAhD;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACnBP;;;;;;;;ACOA,IAAY,cAAZ;;;AAAA,CAAA,UAAY,cAAZ,EAA0B;AACtB,EAAA,cAAA,CAAA,QAAA,CAAA,GAAA,QAAA;AACA,EAAA,cAAA,CAAA,SAAA,CAAA,GAAA,SAAA;AACA,EAAA,cAAA,CAAA,OAAA,CAAA,GAAA,OAAA;AAGA,EAAA,cAAA,CAAA,YAAA,CAAA,GAAA,YAAA;AAIA,EAAA,cAAA,CAAA,yBAAA,CAAA,GAAA,yBAAA;AACA,EAAA,cAAA,CAAA,OAAA,CAAA,GAAA,OAAA;AAEA,EAAA,cAAA,CAAA,eAAA,CAAA,GAAA,eAAA;AAEA,EAAA,cAAA,CAAA,SAAA,CAAA,GAAA,SAAA;AACH,CAhBD,EAAY,cAAc,8BAAd,cAAc,GAAA,EAAA,CAA1B;;;;;;;;ACFA,IAAY,uBAAZ;;;AAAA,CAAA,UAAY,uBAAZ,EAAmC;AACjC,EAAA,uBAAA,CAAA,cAAA,CAAA,GAAA,cAAA;AACA,EAAA,uBAAA,CAAA,eAAA,CAAA,GAAA,eAAA;AACA,EAAA,uBAAA,CAAA,0BAAA,CAAA,GAAA,0BAAA;AACA,EAAA,uBAAA,CAAA,8BAAA,CAAA,GAAA,8BAAA;AAEA,EAAA,uBAAA,CAAA,eAAA,CAAA,GAAA,2CAAA;AAEA,EAAA,uBAAA,CAAA,kBAAA,CAAA,GAAA,kBAAA;AACD,CATD,EAAY,uBAAuB,uCAAvB,uBAAuB,GAAA,EAAA,CAAnC;;AAWA,IAAY,wBAAZ;;;AAAA,CAAA,UAAY,wBAAZ,EAAoC;AAClC,EAAA,wBAAA,CAAA,cAAA,CAAA,GAAA,cAAA;AACA,EAAA,wBAAA,CAAA,YAAA,CAAA,GAAA,YAAA;AACA,EAAA,wBAAA,CAAA,2BAAA,CAAA,GAAA,2BAAA;AACD,CAJD,EAAY,wBAAwB,wCAAxB,wBAAwB,GAAA,EAAA,CAApC;;AAgCA,IAAY,6BAAZ;;;AAAA,CAAA,UAAY,6BAAZ,EAAyC;AACvC,EAAA,6BAAA,CAAA,OAAA,CAAA,GAAA,gBAAA;AACD,CAFD,EAAY,6BAA6B,6CAA7B,6BAA6B,GAAA,EAAA,CAAzC;;;;;;;;;;;;;ACV6E;;;;;;;;ACtC7E;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AACA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AACA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AACA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AACA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AACA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;ACLA;;AAEO,MAAM,mBAAmB,GAAG,gBAA5B;;AACA,MAAM,uBAAuB,GAAG,qBAAhC;;AACA,MAAM,kBAAkB,GAAG,gBAA3B;;AAEA,MAAM,gBAAgB,GAAG,yBAAoB,yBAAoB,MAApB,GAA6B,CAAjD,CAAzB;;AACA,MAAM,iBAAiB,GAAG,0BAAqB,0BAAqB,MAArB,GAA8B,CAAnD,CAA1B;;;;ACPP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;ACnHA;;AACA;;AAOA,IAAY,kBAAZ;;;AAAA,CAAA,UAAY,kBAAZ,EAA8B;AAC5B,EAA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","file":"index.js","sourceRoot":"../../../../src/metapage","sourcesContent":["'use strict';\n\nvar has = Object.prototype.hasOwnProperty\n  , prefix = '~';\n\n/**\n * Constructor to create a storage for our `EE` objects.\n * An `Events` instance is a plain object whose properties are event names.\n *\n * @constructor\n * @private\n */\nfunction Events() {}\n\n//\n// We try to not inherit from `Object.prototype`. In some engines creating an\n// instance in this way is faster than calling `Object.create(null)` directly.\n// If `Object.create(null)` is not supported we prefix the event names with a\n// character to make sure that the built-in object properties are not\n// overridden or used as an attack vector.\n//\nif (Object.create) {\n  Events.prototype = Object.create(null);\n\n  //\n  // This hack is needed because the `__proto__` property is still inherited in\n  // some old browsers like Android 4, iPhone 5.1, Opera 11 and Safari 5.\n  //\n  if (!new Events().__proto__) prefix = false;\n}\n\n/**\n * Representation of a single event listener.\n *\n * @param {Function} fn The listener function.\n * @param {*} context The context to invoke the listener with.\n * @param {Boolean} [once=false] Specify if the listener is a one-time listener.\n * @constructor\n * @private\n */\nfunction EE(fn, context, once) {\n  this.fn = fn;\n  this.context = context;\n  this.once = once || false;\n}\n\n/**\n * Add a listener for a given event.\n *\n * @param {EventEmitter} emitter Reference to the `EventEmitter` instance.\n * @param {(String|Symbol)} event The event name.\n * @param {Function} fn The listener function.\n * @param {*} context The context to invoke the listener with.\n * @param {Boolean} once Specify if the listener is a one-time listener.\n * @returns {EventEmitter}\n * @private\n */\nfunction addListener(emitter, event, fn, context, once) {\n  if (typeof fn !== 'function') {\n    throw new TypeError('The listener must be a function');\n  }\n\n  var listener = new EE(fn, context || emitter, once)\n    , evt = prefix ? prefix + event : event;\n\n  if (!emitter._events[evt]) emitter._events[evt] = listener, emitter._eventsCount++;\n  else if (!emitter._events[evt].fn) emitter._events[evt].push(listener);\n  else emitter._events[evt] = [emitter._events[evt], listener];\n\n  return emitter;\n}\n\n/**\n * Clear event by name.\n *\n * @param {EventEmitter} emitter Reference to the `EventEmitter` instance.\n * @param {(String|Symbol)} evt The Event name.\n * @private\n */\nfunction clearEvent(emitter, evt) {\n  if (--emitter._eventsCount === 0) emitter._events = new Events();\n  else delete emitter._events[evt];\n}\n\n/**\n * Minimal `EventEmitter` interface that is molded against the Node.js\n * `EventEmitter` interface.\n *\n * @constructor\n * @public\n */\nfunction EventEmitter() {\n  this._events = new Events();\n  this._eventsCount = 0;\n}\n\n/**\n * Return an array listing the events for which the emitter has registered\n * listeners.\n *\n * @returns {Array}\n * @public\n */\nEventEmitter.prototype.eventNames = function eventNames() {\n  var names = []\n    , events\n    , name;\n\n  if (this._eventsCount === 0) return names;\n\n  for (name in (events = this._events)) {\n    if (has.call(events, name)) names.push(prefix ? name.slice(1) : name);\n  }\n\n  if (Object.getOwnPropertySymbols) {\n    return names.concat(Object.getOwnPropertySymbols(events));\n  }\n\n  return names;\n};\n\n/**\n * Return the listeners registered for a given event.\n *\n * @param {(String|Symbol)} event The event name.\n * @returns {Array} The registered listeners.\n * @public\n */\nEventEmitter.prototype.listeners = function listeners(event) {\n  var evt = prefix ? prefix + event : event\n    , handlers = this._events[evt];\n\n  if (!handlers) return [];\n  if (handlers.fn) return [handlers.fn];\n\n  for (var i = 0, l = handlers.length, ee = new Array(l); i < l; i++) {\n    ee[i] = handlers[i].fn;\n  }\n\n  return ee;\n};\n\n/**\n * Return the number of listeners listening to a given event.\n *\n * @param {(String|Symbol)} event The event name.\n * @returns {Number} The number of listeners.\n * @public\n */\nEventEmitter.prototype.listenerCount = function listenerCount(event) {\n  var evt = prefix ? prefix + event : event\n    , listeners = this._events[evt];\n\n  if (!listeners) return 0;\n  if (listeners.fn) return 1;\n  return listeners.length;\n};\n\n/**\n * Calls each of the listeners registered for a given event.\n *\n * @param {(String|Symbol)} event The event name.\n * @returns {Boolean} `true` if the event had listeners, else `false`.\n * @public\n */\nEventEmitter.prototype.emit = function emit(event, a1, a2, a3, a4, a5) {\n  var evt = prefix ? prefix + event : event;\n\n  if (!this._events[evt]) return false;\n\n  var listeners = this._events[evt]\n    , len = arguments.length\n    , args\n    , i;\n\n  if (listeners.fn) {\n    if (listeners.once) this.removeListener(event, listeners.fn, undefined, true);\n\n    switch (len) {\n      case 1: return listeners.fn.call(listeners.context), true;\n      case 2: return listeners.fn.call(listeners.context, a1), true;\n      case 3: return listeners.fn.call(listeners.context, a1, a2), true;\n      case 4: return listeners.fn.call(listeners.context, a1, a2, a3), true;\n      case 5: return listeners.fn.call(listeners.context, a1, a2, a3, a4), true;\n      case 6: return listeners.fn.call(listeners.context, a1, a2, a3, a4, a5), true;\n    }\n\n    for (i = 1, args = new Array(len -1); i < len; i++) {\n      args[i - 1] = arguments[i];\n    }\n\n    listeners.fn.apply(listeners.context, args);\n  } else {\n    var length = listeners.length\n      , j;\n\n    for (i = 0; i < length; i++) {\n      if (listeners[i].once) this.removeListener(event, listeners[i].fn, undefined, true);\n\n      switch (len) {\n        case 1: listeners[i].fn.call(listeners[i].context); break;\n        case 2: listeners[i].fn.call(listeners[i].context, a1); break;\n        case 3: listeners[i].fn.call(listeners[i].context, a1, a2); break;\n        case 4: listeners[i].fn.call(listeners[i].context, a1, a2, a3); break;\n        default:\n          if (!args) for (j = 1, args = new Array(len -1); j < len; j++) {\n            args[j - 1] = arguments[j];\n          }\n\n          listeners[i].fn.apply(listeners[i].context, args);\n      }\n    }\n  }\n\n  return true;\n};\n\n/**\n * Add a listener for a given event.\n *\n * @param {(String|Symbol)} event The event name.\n * @param {Function} fn The listener function.\n * @param {*} [context=this] The context to invoke the listener with.\n * @returns {EventEmitter} `this`.\n * @public\n */\nEventEmitter.prototype.on = function on(event, fn, context) {\n  return addListener(this, event, fn, context, false);\n};\n\n/**\n * Add a one-time listener for a given event.\n *\n * @param {(String|Symbol)} event The event name.\n * @param {Function} fn The listener function.\n * @param {*} [context=this] The context to invoke the listener with.\n * @returns {EventEmitter} `this`.\n * @public\n */\nEventEmitter.prototype.once = function once(event, fn, context) {\n  return addListener(this, event, fn, context, true);\n};\n\n/**\n * Remove the listeners of a given event.\n *\n * @param {(String|Symbol)} event The event name.\n * @param {Function} fn Only remove the listeners that match this function.\n * @param {*} context Only remove the listeners that have this context.\n * @param {Boolean} once Only remove one-time listeners.\n * @returns {EventEmitter} `this`.\n * @public\n */\nEventEmitter.prototype.removeListener = function removeListener(event, fn, context, once) {\n  var evt = prefix ? prefix + event : event;\n\n  if (!this._events[evt]) return this;\n  if (!fn) {\n    clearEvent(this, evt);\n    return this;\n  }\n\n  var listeners = this._events[evt];\n\n  if (listeners.fn) {\n    if (\n      listeners.fn === fn &&\n      (!once || listeners.once) &&\n      (!context || listeners.context === context)\n    ) {\n      clearEvent(this, evt);\n    }\n  } else {\n    for (var i = 0, events = [], length = listeners.length; i < length; i++) {\n      if (\n        listeners[i].fn !== fn ||\n        (once && !listeners[i].once) ||\n        (context && listeners[i].context !== context)\n      ) {\n        events.push(listeners[i]);\n      }\n    }\n\n    //\n    // Reset the array, or remove it completely if we have no more listeners.\n    //\n    if (events.length) this._events[evt] = events.length === 1 ? events[0] : events;\n    else clearEvent(this, evt);\n  }\n\n  return this;\n};\n\n/**\n * Remove all listeners, or those of the specified event.\n *\n * @param {(String|Symbol)} [event] The event name.\n * @returns {EventEmitter} `this`.\n * @public\n */\nEventEmitter.prototype.removeAllListeners = function removeAllListeners(event) {\n  var evt;\n\n  if (event) {\n    evt = prefix ? prefix + event : event;\n    if (this._events[evt]) clearEvent(this, evt);\n  } else {\n    this._events = new Events();\n    this._eventsCount = 0;\n  }\n\n  return this;\n};\n\n//\n// Alias methods names because people roll like that.\n//\nEventEmitter.prototype.off = EventEmitter.prototype.removeListener;\nEventEmitter.prototype.addListener = EventEmitter.prototype.on;\n\n//\n// Expose the prefix.\n//\nEventEmitter.prefixed = prefix;\n\n//\n// Allow `EventEmitter` to be imported as module namespace.\n//\nEventEmitter.EventEmitter = EventEmitter;\n\n//\n// Expose the module.\n//\nif ('undefined' !== typeof module) {\n  module.exports = EventEmitter;\n}\n","// There used to be a single version, but there's no reason to upgrade both versions\n// simultaneously. Same vesions are an ideal, but forcing it is also bad\n\nexport enum VersionsMetaframe {\n\tV0_3 = \"0.3\",\n\tV0_4 = \"0.4\",\n}\n\nexport enum VersionsMetapage {\n\tV0_2 = \"0.2\",\n\tV0_3 = \"0.3\",\n}\n\nexport const MetaframeVersionsAll = Object.keys(VersionsMetaframe);\n\nexport const MetaframeVersionCurrent = VersionsMetaframe.V0_4;\n\nexport const MetapageVersionsAll = Object.keys(VersionsMetapage);\n\nexport const MetapageVersionCurrent = VersionsMetapage.V0_3;\n","export { MetaframeVersionCurrent, MetapageVersionCurrent, MetaframeVersionsAll, MetapageVersionsAll } from './versions';\nexport type Url = string;\nexport type MetaframePipeId = string;\nexport type MetaframeId = string;\nexport type MetapageId = string;\n","\nimport {\n    MetaframeId,\n    MetapageDefinition\n} from \".\";\nimport { MetapageIFrameRpcClient } from \"../MetapageIFrameRpcClient\";\n\nexport enum MetapageEvents {\n    Inputs = \"inputs\",\n    Outputs = \"outputs\",\n    State = \"state\",\n    // The definition has already changed e.g. a metaframe changes its hash params\n    // so the current definition now contains that change\n    Definition = \"definition\",\n    // A plugin is requesting to modify the definition\n    // This is not automatically processed, the context of the metapage decides what\n    // to do with this update (apply, recreate metapage, ignore etc)\n    DefinitionUpdateRequest = \"definitionupdaterequest\",\n    Error = \"error\",\n    // when a metaframe wants to tell the metapage of the new URL (for saving state/config)\n    UrlHashUpdate = \"urlhashupdate\",\n    // general event, all events are emitted in their raw form to this namespace\n    Message = \"Message\",\n}\n\n\nexport interface MetapageEventDefinition {\n    definition: MetapageDefinition;\n    metaframes: {\n        [key: string]: MetapageIFrameRpcClient;\n    };\n    plugins?: {\n        [key: string]: MetapageIFrameRpcClient;\n    };\n}\n\nexport type MetapageEventUrlHashUpdate = {\n    metaframe: MetaframeId;\n    hash: string;\n}\n","import { MetaframeId, MetapageId } from \"./core\";\nimport { VersionsMetaframe, VersionsMetapage } from \"./versions\";\nimport { MetaframeInputMap} from \"./metapage\";\nimport { JsonRpcRequest } from '../jsonrpc2';\n\nexport enum JsonRpcMethodsFromChild {\n  InputsUpdate = \"InputsUpdate\",\n  OutputsUpdate = \"OutputsUpdate\",\n  SetupIframeClientRequest = \"SetupIframeClientRequest\",\n  SetupIframeServerResponseAck = \"SetupIframeServerResponseAck\",\n  // Plugin API\n  PluginRequest = \"SetupIframeServerPluginRequestResponseAck\", // See further definitions: ApiPayloadPluginRequest*\n  // Experimental feature\n  HashParamsUpdate = \"HashParamsUpdate\",\n}\n\nexport enum JsonRpcMethodsFromParent {\n  InputsUpdate = \"InputsUpdate\",\n  MessageAck = \"MessageAck\",\n  SetupIframeServerResponse = \"SetupIframeServerResponse\"\n}\n\nexport interface SetupIframeServerResponseData {\n  iframeId: MetaframeId;\n  parentId: MetapageId;\n  state: {\n    inputs: MetaframeInputMap\n  };\n  // Allow newer metaframes to handle older metapage versions\n  version: VersionsMetapage;\n  //is this metaframe a plugin?\n  plugin: boolean;\n}\n\nexport interface MinimumClientMessage<T> extends JsonRpcRequest<T> {\n  iframeId: MetaframeId | undefined;\n  parentId: MetapageId | undefined;\n}\n\nexport interface SetupIframeClientAckData<T> extends MinimumClientMessage<T> {\n  version: VersionsMetaframe;\n}\n\nexport interface ClientMessageRecievedAck<T> {\n  message: MinimumClientMessage<T>;\n}\n\n// Plugin API definitions\nexport enum ApiPayloadPluginRequestMethod {\n  State = \"metapage/state\"\n}\n\nexport interface ApiPayloadPluginRequest {\n  method: ApiPayloadPluginRequestMethod;\n}\n","import { VersionsMetapage } from './versions';\nimport { MetapageId, Url } from './core';\nimport { MetaframeInstance } from './metaframe';\n\nexport interface MetapageOptions {\n    id?: MetapageId;\n    color?: string;\n}\n\nexport type MetapageMetadata = {\n    name?: string;\n    description?: string;\n    // the idea is there *could* be different ways of displaying the metapage, so we store the preferred ways here\n    // you cannot really bake in which one is the \"default\" since that is not under our control nor should we care\n    // but we can have preferences\n    layouts?: {\n        [key in string]: any\n    };\n    // layout?: MetapageMetadataLayout;\n};\n\nexport interface MetapageDefinition {\n    id?: MetapageId;\n    // Best to require this even if annoying to users. It's like the docker-compose.yml version. Human velocity changes (slow but steady)\n    version: VersionsMetapage;\n    metaframes: { [key: string]: MetaframeInstance; };\n    // The plugin URLs point to the path containing a MetaframeInstance JSON\n    // It's an array because it needs to be sorted, but currently don't allow duplicate plugin URLs\n    meta?: MetapageMetadata;\n    // The plugin URLs point to the path containing a MetaframeInstance JSON\n    // It's an array because it needs to be sorted, but currently don't allow duplicate plugin URLs\n    plugins?: Url[];\n}\n\nexport type MetaframeInputMap = {\n    [key: string]: any\n}; // key: MetaframePipeId\n\nexport interface MetapageInstanceInputs { [key: string]: MetaframeInputMap; };\n","export * from \"./core\";\nexport * from \"./events\";\nexport * from \"./jsonrpc\";\nexport * from \"./metaframe\";\nexport * from \"./metapage\";\nexport * from \"./versions\";\n","import {MetapageVersionsAll, MetaframeVersionsAll} from \"./v0_4\";\n\nexport const METAFRAME_JSON_FILE = \"metaframe.json\";\nexport const METAPAGE_KEY_DEFINITION = \"metapage/definition\";\nexport const METAPAGE_KEY_STATE = \"metapage/state\";\n\nexport const VERSION_METAPAGE = MetapageVersionsAll[MetapageVersionsAll.length - 1];\nexport const VERSION_METAFRAME = MetaframeVersionsAll[MetaframeVersionsAll.length - 1];\n","/* global define */\n(function (root, factory) {\n  /* istanbul ignore next */\n  if (typeof define === 'function' && define.amd) {\n    define([], factory);\n  } else if (typeof exports === 'object') {\n    module.exports = factory();\n  } else {\n    root.compareVersions = factory();\n  }\n}(this, function () {\n\n  var semver = /^v?(?:\\d+)(\\.(?:[x*]|\\d+)(\\.(?:[x*]|\\d+)(\\.(?:[x*]|\\d+))?(?:-[\\da-z\\-]+(?:\\.[\\da-z\\-]+)*)?(?:\\+[\\da-z\\-]+(?:\\.[\\da-z\\-]+)*)?)?)?$/i;\n\n  function indexOrEnd(str, q) {\n    return str.indexOf(q) === -1 ? str.length : str.indexOf(q);\n  }\n\n  function split(v) {\n    var c = v.replace(/^v/, '').replace(/\\+.*$/, '');\n    var patchIndex = indexOrEnd(c, '-');\n    var arr = c.substring(0, patchIndex).split('.');\n    arr.push(c.substring(patchIndex + 1));\n    return arr;\n  }\n\n  function tryParse(v) {\n    return isNaN(Number(v)) ? v : Number(v);\n  }\n\n  function validate(version) {\n    if (typeof version !== 'string') {\n      throw new TypeError('Invalid argument expected string');\n    }\n    if (!semver.test(version)) {\n      throw new Error('Invalid argument not valid semver (\\''+version+'\\' received)');\n    }\n  }\n\n  function compareVersions(v1, v2) {\n    [v1, v2].forEach(validate);\n\n    var s1 = split(v1);\n    var s2 = split(v2);\n\n    for (var i = 0; i < Math.max(s1.length - 1, s2.length - 1); i++) {\n      var n1 = parseInt(s1[i] || 0, 10);\n      var n2 = parseInt(s2[i] || 0, 10);\n\n      if (n1 > n2) return 1;\n      if (n2 > n1) return -1;\n    }\n\n    var sp1 = s1[s1.length - 1];\n    var sp2 = s2[s2.length - 1];\n\n    if (sp1 && sp2) {\n      var p1 = sp1.split('.').map(tryParse);\n      var p2 = sp2.split('.').map(tryParse);\n\n      for (i = 0; i < Math.max(p1.length, p2.length); i++) {\n        if (p1[i] === undefined || typeof p2[i] === 'string' && typeof p1[i] === 'number') return -1;\n        if (p2[i] === undefined || typeof p1[i] === 'string' && typeof p2[i] === 'number') return 1;\n\n        if (p1[i] > p2[i]) return 1;\n        if (p2[i] > p1[i]) return -1;\n      }\n    } else if (sp1 || sp2) {\n      return sp1 ? -1 : 1;\n    }\n\n    return 0;\n  };\n\n  var allowedOperators = [\n    '>',\n    '>=',\n    '=',\n    '<',\n    '<='\n  ];\n\n  var operatorResMap = {\n    '>': [1],\n    '>=': [0, 1],\n    '=': [0],\n    '<=': [-1, 0],\n    '<': [-1]\n  };\n\n  function validateOperator(op) {\n    if (typeof op !== 'string') {\n      throw new TypeError('Invalid operator type, expected string but got ' + typeof op);\n    }\n    if (allowedOperators.indexOf(op) === -1) {\n      throw new TypeError('Invalid operator, expected one of ' + allowedOperators.join('|'));\n    }\n  }\n\n  compareVersions.validate = function(version) {\n    return typeof version === 'string' && semver.test(version);\n  }\n\n  compareVersions.compare = function (v1, v2, operator) {\n    // Validate operator\n    validateOperator(operator);\n\n    // since result of compareVersions can only be -1 or 0 or 1\n    // a simple map can be used to replace switch\n    var res = compareVersions(v1, v2);\n    return operatorResMap[operator].indexOf(res) > -1;\n  }\n\n  return compareVersions;\n}));\n","import { EventEmitter } from \"eventemitter3\";\nimport {\n  JsonRpcMethodsFromParent,\n  MetapageDefinition,\n  VersionsMetapage\n} from \"./v0_4\";\nimport { MetapageEvents } from \"./v0_4/events\";\n\nexport enum MetapageHashParams {\n  mp_debug = \"mp_debug\",\n}\n\nexport const isIframe = (): boolean => {\n  //http://stackoverflow.com/questions/326069/how-to-identify-if-a-webpage-is-being-loaded-inside-an-iframe-or-directly-into-t\n  try {\n    return window !== window.top;\n  } catch (ignored) {\n    return false;\n  }\n};\n\nexport class MetapageShared extends EventEmitter<MetapageEvents | JsonRpcMethodsFromParent> {\n\n  // Easier to ensure this value is never null|undefined\n  _definition: MetapageDefinition = { version: VersionsMetapage.V0_3, metaframes: {} };\n\n  constructor() {\n    super();\n    this.getDefinition = this.getDefinition.bind(this);\n  }\n\n  public error(err: any) {\n    throw 'Subclass should implement';\n  }\n  public getDefinition(): MetapageDefinition {\n    return this._definition;\n  }\n};\n","import { compare } from \"compare-versions\";\nimport { MetapageHashParams } from \"./Shared\";\nimport { MetapageDefinition, MetaframeInputMap, MetaframeId, MetapageId, VersionsMetapage, MetapageVersionCurrent } from \"./v0_4\";\nimport { MetapageDefinition as V0_2MetapageDefinition } from \"./v0_2/all\";\nimport { MetapageDefinition as V0_3MetapageDefinition } from \"./v0_3/all\";\n\n// metapages can convert any past version to the current version.\nexport const convertToCurrentDefinition = (def: any): MetapageDefinition => {\n  if (def === null) {\n    throw \"Metapage definition cannot be null\";\n  }\n  if (typeof def === \"string\") {\n    try {\n      def = JSON.parse(def);\n    } catch (err) {\n      throw `Cannot parse into JSON:\\n${def}`;\n    }\n  }\n\n  // Recursively convert up the version\n  let updatedDefinition: MetapageDefinition;\n  switch (getMatchingVersion(def.version)) {\n    case VersionsMetapage.V0_2:\n      {\n        updatedDefinition = convertToCurrentDefinition(definition_v0_2_to_v0_3(def as V0_2MetapageDefinition));\n        break;\n      }\n    case VersionsMetapage.V0_3:\n      {\n        updatedDefinition = def as MetapageDefinition; // Latest\n        break;\n      }\n    default:\n      console.warn(`Metapage definition version=${def.version} but we only know up to version ${MetapageVersionCurrent}. Assuming the definition is compatible, but it's the future!`);\n      updatedDefinition = def as MetapageDefinition; // Latest\n      break;\n  }\n  return updatedDefinition;\n};\n\nconst definition_v0_2_to_v0_3 = (old: V0_2MetapageDefinition): V0_3MetapageDefinition => {\n  // Exactly the same except v0.3 has plugins\n  old.version = VersionsMetapage.V0_3;\n  return old;\n};\n\n/**\n * Merges new values into the current object.\n * Does NOT check if there are actually new keys.\n * Does NOT check values against each other. This means you\n * can keep sending the same value, and the message will\n * be passed in.\n * Returns true if the original map was modified.\n */\nexport const merge = (current: MetaframeInputMap, newInputs: MetaframeInputMap): boolean => {\n  if (!newInputs) {\n    return false;\n  }\n  let modified = false;\n  Object.keys(newInputs).forEach((pipeId: string) => {\n    modified = true;\n    // undefined means remove the key\n    // null means keep the key, but set to null\n    if (newInputs[pipeId] === undefined) {\n      delete current[pipeId];\n    } else {\n      current[pipeId] = newInputs[pipeId];\n    }\n  });\n  return modified;\n};\n\nexport const getMatchingVersion = (version: string): VersionsMetapage => {\n  if (version == \"latest\") {\n    return MetapageVersionCurrent;\n  } else if (compare(version, \"0.2\", \"<\")) {\n    throw `Unknown version: ${version}`;\n  } else if (compare(version, \"0.2\", \">=\") && compare(version, VersionsMetapage.V0_3, \"<\")) {\n    return VersionsMetapage.V0_2;\n  } else if (compare(version, \"0.3\", \">=\")) {\n    return VersionsMetapage.V0_3;\n  } else {\n    // Return something, assume latest\n    console.log(`Could not match version=${version} to any known version, assuming ${MetapageVersionCurrent}`);\n    return MetapageVersionCurrent;\n  }\n};\n\nexport const getUrlParam = (key: MetapageHashParams): string | null => {\n  if (!window.location.search) {\n    return null;\n  }\n  return new URLSearchParams(window.location.search).get(key);\n};\n\nexport const getUrlParamDebug = (): boolean => {\n  return new URLSearchParams(window.location.search).has(MetapageHashParams.mp_debug);\n};\n\nexport const isDebugFromUrlsParams = (): boolean => {\n  const param = new URLSearchParams(window.location.search).get(MetapageHashParams.mp_debug);\n  return param === \"true\" || param === \"1\";\n};\n\nexport const existsAnyUrlParam = (k: string[]): boolean => {\n  const members = k.filter((param: string) => {\n    return new URLSearchParams(window.location.search).has(param);\n  });\n  return members.length > 0;\n};\n\nexport const generateMetaframeId = (length: number = 8): MetaframeId => {\n  return generateId(length);\n};\n\nexport const generateMetapageId = (length: number = 8): MetapageId => {\n  return generateId(length);\n};\n\nexport const generateNonce = (length: number = 8): string => {\n  return generateId(length);\n};\n\nconst LETTERS = \"abcdefghijklmnopqrstuvwxyz0123456789\";\nexport const generateId = (length: number = 8): string => {\n  var result = \"\";\n  var characters = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789\";\n  var charactersLength = LETTERS.length;\n  for (var i = 0; i < length; i++) {\n    result += LETTERS.charAt(Math.floor(Math.random() * charactersLength));\n  }\n  return result;\n};\n\nexport const log = (o: any, color?: string, backgroundColor?: string) => {\n  color = color\n    ? color\n    : \"000\";\n  if (color && color.trim() == \"\") {\n    color = undefined;\n  }\n  let s: string;\n  if (typeof o === \"string\") {\n    s = o as string;\n  } else if (typeof o === \"number\") {\n    s = o + \"\";\n  } else {\n    s = JSON.stringify(o, null, \"  \");\n  }\n\n  if (color && color.trim() != \"\") {\n    var cssstring = `color: #${color}`;\n    if (backgroundColor) {\n      cssstring = `${cssstring}; background: #${backgroundColor}`;\n    }\n    s = `%c${s}`;\n    window.console.log(s, cssstring);\n  } else {\n    window.console.log(s);\n  }\n};\n\nexport const stringToRgb = (str: string): string => {\n  return intToRGB(hashCode(str));\n};\n\nexport const hashCode = (str: string): number => {\n  // java string#hashCode\n  var hash = 0;\n  for (let i = 0; i < str.length; i++) {\n    hash = str.charCodeAt(i) + ((hash << 5) - hash);\n  }\n  return hash;\n};\n\nexport const intToRGB = (i: number): string => {\n  var c = (i & 0x00ffffff).toString(16).toUpperCase();\n  return \"00000\".substring(0, 6 - c.length) + c;\n};\n\n/*\n * base64-arraybuffer\n * https://github.com/niklasvh/base64-arraybuffer\n *\n * Copyright (c) 2012 Niklas von Hertzen\n * Licensed under the MIT license.\n */\n\nconst chars = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/\";\n\n// Use a lookup table to find the index.\nconst lookup = new Uint8Array(256);\nfor (var i = 0; i < chars.length; i++) {\n  lookup[chars.charCodeAt(i)] = i;\n}\n\nexport function base64encode(arraybuffer: ArrayBuffer): string {\n  let bytes = new Uint8Array(arraybuffer);\n  let i: number;\n  let len = bytes.length;\n  let base64 = \"\";\n\n  for (i = 0; i < len; i += 3) {\n    base64 += chars[bytes[i] >> 2];\n    base64 += chars[((bytes[i] & 3) << 4) | (bytes[i + 1] >> 4)];\n    base64 += chars[((bytes[i + 1] & 15) << 2) | (bytes[i + 2] >> 6)];\n    base64 += chars[bytes[i + 2] & 63];\n  }\n\n  if (len % 3 === 2) {\n    base64 = base64.substring(0, base64.length - 1) + \"=\";\n  } else if (len % 3 === 1) {\n    base64 = base64.substring(0, base64.length - 2) + \"==\";\n  }\n\n  return base64;\n}\n\nexport function base64decode(base64: string): ArrayBuffer {\n  if (!base64) {\n    throw new Error(\"base64decode string argument given\");\n  }\n  let bufferLength = base64.length * 0.75,\n    len = base64.length,\n    i: number,\n    p = 0,\n    encoded1: number,\n    encoded2: number,\n    encoded3: number,\n    encoded4: number;\n\n  if (base64[base64.length - 1] === \"=\") {\n    bufferLength--;\n    if (base64[base64.length - 2] === \"=\") {\n      bufferLength--;\n    }\n  }\n\n  var arraybuffer = new ArrayBuffer(bufferLength),\n    bytes = new Uint8Array(arraybuffer);\n\n  for (i = 0; i < len; i += 4) {\n    encoded1 = lookup[base64.charCodeAt(i)];\n    encoded2 = lookup[base64.charCodeAt(i + 1)];\n    encoded3 = lookup[base64.charCodeAt(i + 2)];\n    encoded4 = lookup[base64.charCodeAt(i + 3)];\n\n    bytes[p++] = (encoded1 << 2) | (encoded2 >> 4);\n    bytes[p++] = ((encoded2 & 15) << 4) | (encoded3 >> 2);\n    bytes[p++] = ((encoded3 & 3) << 6) | (encoded4 & 63);\n  }\n\n  return arraybuffer;\n}\n\n\nexport const isPageLoaded = (): boolean => {\n  return document.readyState == \"complete\" || document.readyState == \"interactive\";\n  // https://stackoverflow.com/questions/13364613/how-to-know-if-window-load-event-was-fired-already/28093606\n  // // TODO ugh casting here but I can't seem to get the right type with the loadEventEnd\n  // return window.performance.getEntriesByType(\"navigation\").every((e) => { return (e as PerformanceNavigationTiming).loadEventEnd > 0 });\n};\n\nexport const pageLoaded = async (): Promise<void> => {\n  if (isPageLoaded()) {\n    return Promise.resolve();\n  }\n  return new Promise((resolve) => {\n    let loaded = false;\n    window.addEventListener('load', () => {\n      if (loaded) {\n        return;\n      }\n      loaded = true;\n      resolve();\n    });\n    // tiny chance of missing the document.readyState === \"loaded\"\n    const timer = setTimeout(() => {\n      if (!loaded && isPageLoaded()) {\n        loaded = true;\n        resolve();\n      }\n    }, 200);\n  })\n};\n","import { EventEmitter, ListenerFn } from \"eventemitter3\";\nimport { VERSION_METAFRAME, METAPAGE_KEY_STATE, METAPAGE_KEY_DEFINITION } from \"./Constants\";\nimport {\n  MetaframeId,\n  MetaframeInputMap,\n  MetaframePipeId,\n  MetapageId,\n  ApiPayloadPluginRequest,\n  ApiPayloadPluginRequestMethod,\n  JsonRpcMethodsFromParent,\n  JsonRpcMethodsFromChild,\n  SetupIframeServerResponseData,\n  MinimumClientMessage,\n  VersionsMetapage\n} from \"./v0_4\";\nimport { isDebugFromUrlsParams, stringToRgb, log as MetapageToolsLog, merge, pageLoaded } from \"./MetapageTools\";\nimport { isIframe } from \"./Shared\";\nimport { MetapageEventUrlHashUpdate } from \"./v0_4/events\";\n\n// TODO combine/unify MetaframeEvents and MetaframeLoadingState\nenum MetaframeLoadingState {\n  WaitingForPageLoad = \"WaitingForPageLoad\",\n  SentSetupIframeClientRequest = \"SentSetupIframeClientRequest\",\n  Ready = \"Ready\"\n}\n\nenum MetaframeEvents {\n  Connected = \"connected\",\n  Error = \"error\",\n  Input = \"input\",\n  Inputs = \"inputs\",\n  Message = \"message\"\n}\n\ntype MetaframeOptions = {\n  disableHashChangeEvent?:boolean;\n}\n\nexport class Metaframe extends EventEmitter<MetaframeEvents | JsonRpcMethodsFromChild> {\n  public static readonly version = VERSION_METAFRAME;\n\n  public static readonly ERROR = MetaframeEvents.Error;\n  public static readonly CONNECTED = MetaframeEvents.Connected;\n  public static readonly INPUT = MetaframeEvents.Input;\n  public static readonly INPUTS = MetaframeEvents.Inputs;\n  public static readonly MESSAGE = MetaframeEvents.Message;\n\n  _inputPipeValues: MetaframeInputMap = {};\n  _outputPipeValues: MetaframeInputMap = {};\n  _parentId: MetapageId | undefined;\n  _parentVersion: VersionsMetapage | undefined;\n  _isIframe: boolean;\n  _state: MetaframeLoadingState = MetaframeLoadingState.WaitingForPageLoad;\n  _messageSendCount = 0;\n\n  debug: boolean = isDebugFromUrlsParams();\n  color: string | undefined;\n  plugin: MetaframePlugin | undefined;\n\n  /**\n   * This is the (locally) unique id that the parent metapage\n   * assigns to the metaframe via iframe.name which we get here as window.name\n   */\n  id: string = window.name;\n\n  constructor(options?:MetaframeOptions) {\n    super();\n    this.debug = isDebugFromUrlsParams();\n    this._isIframe = isIframe();\n\n\n    this.addListener = this.addListener.bind(this);\n    this.dispose = this.dispose.bind(this);\n    this.error = this.error.bind(this);\n    this.getInput = this.getInput.bind(this);\n    this.getInputs = this.getInputs.bind(this);\n    this.getOutput = this.getOutput.bind(this);\n    this.getOutputs = this.getOutputs.bind(this);\n    this.log = this.log.bind(this);\n    this.logInternal = this.logInternal.bind(this);\n    this.onInput = this.onInput.bind(this);\n    this.onInputs = this.onInputs.bind(this);\n    this.onMessage = this.onMessage.bind(this);\n    this.sendRpc = this.sendRpc.bind(this);\n    this.setInput = this.setInput.bind(this);\n    this.setInputs = this.setInputs.bind(this);\n    this.setInternalInputsAndNotify = this.setInternalInputsAndNotify.bind(this);\n    this.setOutput = this.setOutput.bind(this);\n    this.setOutputs = this.setOutputs.bind(this);\n    this.warn = this.warn.bind(this);\n    this._resolveSetupIframeServerResponse = this._resolveSetupIframeServerResponse.bind(this);\n    this.addListenerReturnDisposer = this.addListenerReturnDisposer.bind(this);\n    this.connected = this.connected.bind(this);\n    this.disableNotifyOnHashUrlChange = this.disableNotifyOnHashUrlChange.bind(this);\n    this._onHashUrlChange = this._onHashUrlChange.bind(this);\n\n    if (!this._isIframe) {\n      //Don't add any of the machinery, it only works if we're iframes.\n      //This will never return\n      // this.ready = new Promise((_) => {});\n      this.log(\"Not an iframe, metaframe code disabled\");\n      return;\n    }\n\n    const thisRef = this;\n    // Do no listen or send messages until the page is loaded\n    // This iframe is not created UNTIL the parent page is loaded and listening to messages\n    pageLoaded().then(() => {\n      this.log('pageLoaded')\n      window.addEventListener(\"message\", this.onMessage);\n      // Now that we're listening, request to the parent to register us so we can talk\n      thisRef.sendRpc(JsonRpcMethodsFromChild.SetupIframeClientRequest, { version: Metaframe.version });\n      thisRef._state = MetaframeLoadingState.SentSetupIframeClientRequest;\n    });\n\n    if (!(options?.disableHashChangeEvent)) {\n      window.addEventListener(\"hashchange\", this._onHashUrlChange);\n    }\n  }\n\n  _resolveSetupIframeServerResponse(params: SetupIframeServerResponseData) {\n    if (this._state === MetaframeLoadingState.WaitingForPageLoad) {\n      throw 'Got message but page has not finished loading, we should never get in this state';\n    }\n\n    if (!this._parentId) {\n      this._parentVersion = params.version;\n      this.color = stringToRgb(this.id);\n      this._parentId = params.parentId;\n      this.log(\n        `metapage[${this._parentId}](v${this._parentVersion\n          ? this._parentVersion\n          : \"unknown\"}) registered`);\n\n      this._inputPipeValues = params.state && params.state.inputs\n        ? params.state.inputs\n        : this._inputPipeValues;\n\n      //Tell the parent we have registered.\n      this._state = MetaframeLoadingState.Ready;\n      // TODO why do we need  Metaframe.version here? It was sent in the initial SetupIframeClientRequest\n      this.sendRpc(JsonRpcMethodsFromChild.SetupIframeServerResponseAck, { version: Metaframe.version });\n\n      //Send notifications of initial inputs (if non-null)\n      //so you don't have to listen to the ready event if you don't want to\n      if (this._inputPipeValues && Object.keys(this._inputPipeValues).length > 0) {\n        this.emit(MetaframeEvents.Inputs, this._inputPipeValues);\n        Object.keys(this._inputPipeValues).forEach(pipeId => this.emit(MetaframeEvents.Input, pipeId, this._inputPipeValues[pipeId]));\n      }\n\n      this.emit(MetaframeEvents.Inputs, this._inputPipeValues);\n\n      // if this is a plugin, initialize the plugin object\n      if (params.plugin) {\n        this.plugin = new MetaframePlugin(this);\n      }\n\n      //Resolve AFTER sending inputs. This way consumers can either:\n      //1) Just listen to inputs updates. The first will be when the metaframe is ready\n      //2) Listen to the ready event, get the inputs if desired, and listen to subsequent\n      //   inputs updates. You may not wish to respond to the first updates but you might\n      //   want to know when the metaframe is ready\n      //*** Does this distinction make sense?\n      this.emit(MetaframeEvents.Connected);\n    } else {\n      this.log(\"Got JsonRpcMethods.SetupIframeServerResponse but already resolved\");\n    }\n  }\n\n  async connected(): Promise<void> {\n    if (this._state === MetaframeLoadingState.Ready) {\n      return;\n    }\n    return new Promise((resolve, _) => {\n      let disposer: () => void;\n      disposer = this.addListenerReturnDisposer(MetaframeEvents.Connected, () => {\n        resolve();\n        disposer();\n      });\n    });\n  }\n\n  addListenerReturnDisposer(event: MetaframeEvents | JsonRpcMethodsFromChild, listener: ListenerFn<any[]>): () => void {\n    super.addListener(event, listener);\n    const disposer = () => {\n      super.removeListener(event, listener);\n    };\n    return disposer;\n  }\n\n  public log(o: any, color?: string, backgroundColor?: string) {\n    if (!this.debug) {\n      return;\n    }\n    this.logInternal(\n      o, color\n      ? color\n      : this.color);\n  }\n\n  public warn(o: any) {\n    if (!this.debug) {\n      return;\n    }\n    this.logInternal(o, \"000\", this.color);\n  }\n\n  public error(err: any) {\n    this.logInternal(err, this.color, \"f00\");\n  }\n\n  logInternal(o: any, color?: string, backgroundColor?: string) {\n    let s: string;\n    if (typeof o === \"string\") {\n      s = o as string;\n    } else if (typeof o === \"number\") {\n      s = o + \"\";\n    } else {\n      s = JSON.stringify(o);\n    }\n\n    color = color\n      ? color + \"\"\n      : color;\n\n    s = (\n      this.id\n        ? `Metaframe[${this.id}] `\n        : \"\") + `${s}`;\n    MetapageToolsLog(s, color, backgroundColor);\n  }\n\n  public dispose() {\n    super.removeAllListeners();\n    window.removeEventListener(\"message\", this.onMessage);\n    this.disableNotifyOnHashUrlChange();\n    // @ts-ignore\n    this._inputPipeValues = undefined;\n    // @ts-ignore\n    this._outputPipeValues = undefined;\n\n  }\n\n  public addListener(event: MetaframeEvents | JsonRpcMethodsFromChild, listener: ListenerFn<any[]>) {\n    super.addListener(event, listener);\n\n    //If it is an input or output, set the current input/output values when\n    //attaching a listener on the next tick to ensure that the listener\n    //will always get a value if it exists\n    if (event === MetaframeEvents.Inputs) {\n      window.setTimeout(() => {\n        if (this._inputPipeValues) {\n          listener(this._inputPipeValues);\n        }\n      }, 0);\n    }\n    return this;\n  }\n\n  public onInput(pipeId: MetaframePipeId, listener: any): () => void {\n    return this.addListenerReturnDisposer(MetaframeEvents.Input, (pipe: MetaframePipeId, value: any) => {\n      if (pipeId === pipe) {\n        listener(value);\n      }\n    });\n  }\n\n  public onInputs(listener: (m: MetaframeInputMap) => void): () => void {\n    const disposer = this.addListenerReturnDisposer(MetaframeEvents.Inputs, listener);\n    return disposer;\n  }\n\n  /**\n   * This is a particular use case: metapage inputs are saved outside\n   * the iframe, so when this iframe is restarted in the same metapage\n   * it will start with this value. So in a way, it can be used for\n   * state storage, by the metaframe itself.\n   */\n  public setInput(pipeId: MetaframePipeId, blob: any) {\n    var inputs: MetaframeInputMap = {};\n    inputs[pipeId] = blob;\n    this.setInputs(inputs);\n  }\n\n  /**\n   * This does NOT directly update internal inputs. It tells\n   * the metapage parent, which then updates back. So if there\n   * is no metapage parent, this will do nothing.\n   *\n   * @param inputs\n   */\n  public setInputs(inputs: MetaframeInputMap) {\n    this.sendRpc(JsonRpcMethodsFromChild.InputsUpdate, inputs);\n  }\n\n  setInternalInputsAndNotify(inputs: MetaframeInputMap) {\n    if (!merge(this._inputPipeValues, inputs)) {\n      return;\n    }\n\n    Object.keys(inputs).forEach(pipeId => this.emit(MetaframeEvents.Input, pipeId, inputs[pipeId]));\n    this.emit(MetaframeEvents.Inputs, inputs);\n  }\n\n  public getInput(pipeId: MetaframePipeId): any {\n    console.assert(pipeId);\n    return this._inputPipeValues[pipeId];\n  }\n\n  public getInputs(): MetaframeInputMap {\n    return this._inputPipeValues;\n  }\n\n  public getOutput(pipeId: MetaframePipeId): any {\n    console.assert(pipeId);\n    return this._outputPipeValues[pipeId];\n  }\n\n  /**\n   * What does setting this to null mean?\n   * @param pipeId     :MetaframePipeId [description]\n   * @param updateBlob :any        [description]\n   */\n  public setOutput(pipeId: MetaframePipeId, updateBlob: any): void {\n    console.assert(pipeId);\n    console.assert(updateBlob);\n\n    var outputs: MetaframeInputMap = {};\n    outputs[pipeId] = updateBlob;\n\n    this.setOutputs(outputs);\n  }\n\n  public setOutputs(outputs: MetaframeInputMap): void {\n    if (!merge(this._outputPipeValues, outputs)) {\n      return;\n    }\n    this.sendRpc(JsonRpcMethodsFromChild.OutputsUpdate, outputs);\n  }\n\n  public getOutputs(): MetaframeInputMap {\n    return this._outputPipeValues;\n  }\n\n  /**\n   * If the hash params of our URL changes, e.g. from updating because\n   * our state changed, then notify the parent metapage so that the\n   * parent metapage can save the state\n   */\n  public disableNotifyOnHashUrlChange(): void {\n    window.removeEventListener(\"hashchange\", this._onHashUrlChange);\n  }\n\n  /** Tell the parent metapage our hash params changed */\n  _onHashUrlChange(_: HashChangeEvent): void {\n    const payload: MetapageEventUrlHashUpdate = {\n      hash: window.location.hash,\n      metaframe: this.id as MetaframeId,\n    }\n    this.sendRpc(JsonRpcMethodsFromChild.HashParamsUpdate, payload);\n  }\n\n  sendRpc(method: JsonRpcMethodsFromChild, params: any) {\n    if (this._isIframe) {\n      const message: MinimumClientMessage<any> = {\n        jsonrpc: \"2.0\",\n        id: ++this._messageSendCount, // just increment the counter for the id\n        method: method,\n        params: params,\n        iframeId: this.id,\n        parentId: this._parentId // TODO this is likely not actually needed ? iframes cannot send to anyone but the parent? But the parent does not automatically know where a message comes from\n      };\n      window.parent.postMessage(message, \"*\");\n    } else {\n      this.log(\"Cannot send JSON-RPC window message: there is no window.parent which means we are not an iframe\");\n    }\n  }\n\n  onMessage(e: MessageEvent) {\n    if (typeof e.data === \"object\") {\n      let jsonrpc: MinimumClientMessage<any> = e.data;\n      if (jsonrpc.jsonrpc === \"2.0\") {\n        //Make sure this is a jsonrpc object\n        var method = jsonrpc.method as JsonRpcMethodsFromParent;\n        if (!(method == JsonRpcMethodsFromParent.SetupIframeServerResponse || (jsonrpc.parentId == this._parentId && jsonrpc.iframeId == this.id))) {\n          this.error(`window.message: received message but jsonrpc.parentId=${jsonrpc.parentId} _parentId=${this._parentId} jsonrpc.iframeId=${jsonrpc.iframeId} id=${this.id}`);\n          return;\n        }\n\n        switch (method) {\n          case JsonRpcMethodsFromParent.SetupIframeServerResponse:\n            this._resolveSetupIframeServerResponse(jsonrpc.params);\n            break; //Handled elsewhere\n          case JsonRpcMethodsFromParent.InputsUpdate:\n            if (this._state !== MetaframeLoadingState.Ready) {\n              throw 'Got InputsUpdate but metaframe is not MetaframeLoadingState.Ready';\n            }\n            this.setInternalInputsAndNotify(jsonrpc.params.inputs);\n            break;\n          case JsonRpcMethodsFromParent.MessageAck:\n            if (this.debug)\n              this.log(`ACK: ${JSON.stringify(jsonrpc)}`);\n            break;\n          default:\n            if (this.debug)\n              this.log(`window.message: unknown JSON-RPC method: ${JSON.stringify(jsonrpc)}`);\n            break;\n        }\n\n        this.emit(MetaframeEvents.Message, jsonrpc);\n      }\n    }\n  }\n}\n\n/**\n * A special kind of metaframe that can get and set the metapage definition\n * and metapage state (so quite powerful).\n */\nexport class MetaframePlugin {\n  _metaframe: Metaframe;\n\n  constructor(metaframe: Metaframe) {\n    this._metaframe = metaframe;\n    this.requestState = this.requestState.bind(this);\n    this.onState = this.onState.bind(this);\n    this.getState = this.getState.bind(this);\n    this.setState = this.setState.bind(this);\n    this.onDefinition = this.onDefinition.bind(this);\n    this.getDefinition = this.getDefinition.bind(this);\n    this.setDefinition = this.setDefinition.bind(this);\n  }\n\n  requestState() {\n    var payload: ApiPayloadPluginRequest = {\n      method: ApiPayloadPluginRequestMethod.State\n    };\n    this._metaframe.sendRpc(JsonRpcMethodsFromChild.PluginRequest, payload);\n  }\n\n  onState(listener: (_: any) => void): () => void {\n    const disposer = this._metaframe.onInput(METAPAGE_KEY_STATE, listener);\n    if (this.getState()) {\n      listener(this.getState());\n    }\n    return disposer;\n  }\n\n  getState(): any {\n    return this._metaframe.getInput(METAPAGE_KEY_STATE);\n  }\n\n  setState(state: any) {\n    this._metaframe.setOutput(METAPAGE_KEY_STATE, state);\n  }\n\n  onDefinition(listener: (a: any) => void): () => void {\n    var disposer = this._metaframe.onInput(METAPAGE_KEY_DEFINITION, listener);\n    if (this.getDefinition()) {\n      listener(this.getDefinition());\n    }\n    return disposer;\n  }\n\n  setDefinition(definition: any) {\n    this._metaframe.setOutput(METAPAGE_KEY_DEFINITION, definition);\n  }\n\n  getDefinition(): any {\n    return this._metaframe.getInput(METAPAGE_KEY_DEFINITION);\n  }\n}\n"]}