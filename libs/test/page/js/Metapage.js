parcelRequire=function(e,r,t,n){var i,o="function"==typeof parcelRequire&&parcelRequire,u="function"==typeof require&&require;function f(t,n){if(!r[t]){if(!e[t]){var i="function"==typeof parcelRequire&&parcelRequire;if(!n&&i)return i(t,!0);if(o)return o(t,!0);if(u&&"string"==typeof t)return u(t);var c=new Error("Cannot find module '"+t+"'");throw c.code="MODULE_NOT_FOUND",c}p.resolve=function(r){return e[t][1][r]||r},p.cache={};var l=r[t]=new f.Module(t);e[t][0].call(l.exports,p,l,l.exports,this)}return r[t].exports;function p(e){return f(p.resolve(e))}}f.isParcelRequire=!0,f.Module=function(e){this.id=e,this.bundle=f,this.exports={}},f.modules=e,f.cache=r,f.parent=o,f.register=function(r,t){e[r]=[function(e,r){r.exports=t},{}]};for(var c=0;c<t.length;c++)try{f(t[c])}catch(e){i||(i=e)}if(t.length){var l=f(t[t.length-1]);"object"==typeof exports&&"undefined"!=typeof module?module.exports=l:"function"==typeof define&&define.amd?define(function(){return l}):n&&(this[n]=l)}if(parcelRequire=f,i)throw i;return f}({"Vntl":[function(require,module,exports) {
function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}function e(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function s(t,e){for(var s=0;s<e.length;s++){var i=e[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function i(t,e,i){return e&&s(t.prototype,e),i&&s(t,i),t}function n(t,e,s){return(n="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,s){var i=a(t,e);if(i){var n=Object.getOwnPropertyDescriptor(i,e);return n.get?n.get.call(s):n.value}})(t,e,s||t)}function a(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=h(t)););return t}function r(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&u(t,e)}function u(t,e){return(u=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function o(t){return function(){var e,s=h(t);if(c()){var i=h(this).constructor;e=Reflect.construct(s,arguments,i)}else e=s.apply(this,arguments);return l(this,e)}}function l(e,s){return!s||"object"!==t(s)&&"function"!=typeof s?f(e):s}function f(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function c(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(t){return!1}}function h(t){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}System.register(["./EventEmitter","minimatch","../Constants","../MetaLibsVersion","@definitions/JsonRpcMethods","./MetapageTools"],function(s,a){"use strict";var u,l,c,p,m,d,g,_,v,y,I,b,k=this&&this.__awaiter||function(t,e,s,i){return new(s||(s=Promise))(function(n,a){function r(t){try{o(i.next(t))}catch(e){a(e)}}function u(t){try{o(i.throw(t))}catch(e){a(e)}}function o(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s(function(t){t(e)})).then(r,u)}o((i=i.apply(t,e||[])).next())})};a&&a.id;return{setters:[function(t){u=t},function(t){l=t},function(t){c=t},function(t){p=t},function(t){m=t},function(t){d=t}],execute:function(){!function(t){t.Inputs="inputs",t.Outputs="outputs",t.State="state",t.Definition="definition",t.Error="error"}(g||(g={})),s("MetapageEvents",g),function(t){t.all="all",t.delta="delta"}(_||(_={})),s("MetapageEventStateType",_),v=function(){return{metaframes:{inputs:{},outputs:{}},plugins:{inputs:{},outputs:{}}}},s("getLibraryVersionMatching",function(t){return d.getMatchingVersion(t)}),y="bcbcbc",s("Metapage",I=function(s){r(_,u.EventEmitter);var a=o(_);function _(t){var s;return e(this,_),(s=a.call(this))._state=v(),s._metaframes={},s._plugins={},s._pluginOrder=[],s.debug=!1,s._cachedInputLookupMap={},s._inputMap={},s._id=null!=t&&null!=t.id?t.id:d.generateMetapageId(),s._consoleBackgroundColor=null!=t&&null!=t.color?t.color:y,s.onMessage=s.onMessage.bind(f(s)),window.addEventListener("message",s.onMessage),s.log("Initialized"),s}return i(_,[{key:"setDebugFromUrlParams",value:function(){return this.debug=d.existsAnyUrlParam(["MP_DEBUG","DEBUG","debug","mp_debug"]),this}},{key:"getState",value:function(){return this._state}},{key:"onState",value:function(t){var e=this.addEventListener(g.State,t);return t(this._state),e}},{key:"setState",value:function(t){var e=this;this._state=t,this.getMetaframeIds().forEach(function(t){e.getMetaframe(t).setInputs(e._state.metaframes.inputs[t]),e.getMetaframe(t).setOutputs(e._state.metaframes.outputs[t])}),this.getPluginIds().forEach(function(t){e.getPlugin(t).setInputs(e._state.plugins.inputs[t]),e.getPlugin(t).setOutputs(e._state.plugins.outputs[t])}),this.emit(g.State,this._state)}},{key:"getStateMetaframes",value:function(){return this._state.metaframes}},{key:"getStatePlugins",value:function(){return this._state.metaframes}},{key:"getDefinition",value:function(){return this._definition}},{key:"setDefinition",value:function(e,s){var i=this,n=d.convertToCurrentDefinition(e);null!=n.metaframes&&Object.keys(n.metaframes).forEach(function(e){if(n.plugins&&n.plugins.includes(e))throw i.emitErrorMessage("Plugin with url=".concat(e," matches metaframe. Metaframe ids and plugin urls are not allowed to collide")),"Plugin with url=".concat(e," matches metaframe. Metaframe ids and plugin urls are not allowed to collide");var s=n.metaframes[e];if("object"!==t(s))throw i.emitErrorMessage('Metaframe "'.concat(e,'" is not an object')),'Metaframe "'.concat(e,'" is not an object');if(!s.url)throw i.emitErrorMessage('Metaframe "'.concat(e,'" missing field: url')),'Metaframe "'.concat(e,'" missing field: url')}),this._definition=n,Object.keys(this._metaframes).forEach(function(t){i._definition.metaframes&&i._definition.metaframes[t]||i.removeMetaframe(t)}),Object.keys(this._plugins).forEach(function(t){i._definition.plugins.includes(t)||i.removePlugin(t)}),this._pluginOrder=null!=this._definition.plugins?this._definition.plugins:[],null!=s&&(this._state=s),null!=this._definition.metaframes&&Object.keys(this._definition.metaframes).forEach(function(t){if(!i._metaframes.hasOwnProperty(t)){var e=i._definition.metaframes[t];i.addMetaframe(t,e)}}),null!=this._definition.plugins&&this._definition.plugins.forEach(function(t){i._plugins.hasOwnProperty(t)||i.addPlugin(t)});var a={definition:this._definition,metaframes:this._metaframes,plugins:this._plugins};return window.setTimeout(function(){i.emit(g.Definition,a),null!=s&&i.emit(g.State,i._state)},0),this}},{key:"addPipe",value:function(t,e){this._inputMap[t]||(this._inputMap[t]=[]),this._inputMap[t].push(e)}},{key:"removeMetaframe",value:function(t){var e=this;this._metaframes[t]&&(this._metaframes[t].dispose(),delete this._metaframes[t],delete this._state.metaframes.inputs[t],delete this._state.metaframes.outputs[t],delete this._inputMap[t],Object.keys(this._inputMap).forEach(function(s){for(var i=e._inputMap[s],n=0;n<=i.length;)i[n].metaframe==t?i.splice(n,1):n++}),this._cachedInputLookupMap={})}},{key:"removePlugin",value:function(t){this._plugins[t]&&(this._plugins[t].dispose(),delete this._plugins[t],delete this._state.plugins.inputs[t],delete this._state.plugins.outputs[t])}},{key:"removeAll",value:function(){var t=this;Object.keys(this._metaframes).forEach(function(e){return t._metaframes[e].dispose()}),Object.keys(this._plugins).forEach(function(e){return t._plugins[e].dispose()}),this._metaframes={},this._plugins={},this._state=v(),this._inputMap={},this._cachedInputLookupMap={}}},{key:"metaframes",value:function(){return this.getMetaframes()}},{key:"metaframeIds",value:function(){return this.getMetaframeIds()}},{key:"getMetaframeIds",value:function(){return Object.keys(this._metaframes)}},{key:"getMetaframes",value:function(){return Object.assign({},this._metaframes)}},{key:"plugins",value:function(){return Object.assign({},this._plugins)}},{key:"pluginIds",value:function(){return this.getPluginIds()}},{key:"getPluginIds",value:function(){return this._pluginOrder.slice(0)}},{key:"getMetaframe",value:function(t){return this._metaframes[t]}},{key:"getPlugin",value:function(t){return this._plugins[t]}},{key:"addMetaframe",value:function(t,e){var s=this;if(!t)throw"addMetaframe missing metaframeId";if(!e)throw"addMetaframe missing definition";if(this._metaframes[t])throw this.emitErrorMessage("Existing metaframe for id=".concat(t)),"Existing metaframe for id=".concat(t);if(!e.url)throw this.emitErrorMessage("Metaframe definition missing url id=".concat(t)),"Metaframe definition missing url id=".concat(t);var i=new b(e.url,t,this._id,this._consoleBackgroundColor,this.debug).setMetapage(this);return this._metaframes[t]=i,null!=e.inputs&&e.inputs.forEach(function(e){return s.addPipe(t,e)}),i.setInputs(this._state.metaframes.inputs[t]),i}},{key:"addPlugin",value:function(t){if(!t)throw"Plugin missing url";var e=new b(t,t,this._id,this._consoleBackgroundColor,this.debug).setInputs(this._state.plugins.inputs[t]).setMetapage(this).setPlugin();return this._plugins[t]=e,e}},{key:"dispose",value:function(){var t=this;n(h(_.prototype),"dispose",this).call(this),window.removeEventListener("message",this.onMessage),Object.keys(this._metaframes).forEach(function(e){return t._metaframes[e].dispose()}),Object.keys(this._plugins).forEach(function(e){return t._plugins[e].dispose()}),this._id=null,this._metaframes=null,this._plugins=null,this._state=null,this._definition=null,this._cachedInputLookupMap=null,this._inputMap=null}},{key:"log",value:function(t,e,s){this.debug&&this.logInternal(t,e,s)}},{key:"error",value:function(t){this.logInternal(t,"f00",this._consoleBackgroundColor),this.emitErrorMessage("".concat(t))}},{key:"emitErrorMessage",value:function(t){this.emit(g.Error,t)}},{key:"getInputsFromOutput",value:function(t,e){var s=this;if(this._cachedInputLookupMap[t]||(this._cachedInputLookupMap[t]={}),!this._cachedInputLookupMap[t][e]){var i=[];this._cachedInputLookupMap[t][e]=i,Object.keys(this._inputMap).forEach(function(n){n!==t&&s._inputMap[n].forEach(function(s){if(s.metaframe==t&&l(e,s.source)){var a=s.target;s.target&&!s.target.startsWith("*")&&""!==s.target||(a=e),i.push({metaframe:n,pipe:a})}})})}return this._cachedInputLookupMap[t][e]}},{key:"isValidJSONRpcMessage",value:function(t){if("2.0"!==t.jsonrpc)return!1;switch(t.method){case m.JsonRpcMethodsFromChild.SetupIframeClientRequest:return!0;default:var e=t.iframeId;return!(t.parentId!==this._id||!this._metaframes[e]&&!this._plugins[e])||(this.error("message.parentId=".concat(t.parentId," this._id=").concat(this._id," message.iframeId=").concat(e," this._metaframes.exists(message.iframeId)=").concat(void 0!==this._metaframes[e]," this._plugins.exists(message.iframeId)=").concat(void 0!==this._plugins[e]," message=").concat(JSON.stringify(t).substr(0,200))),!1)}}},{key:"setInput",value:function(t,e,s){this.setInputStateOnly(t,e,s),this.setMetaframeClientInputAndSentClientEvent(t,e,s),this.emit(g.State,this._state)}},{key:"setMetaframeClientInputAndSentClientEvent",value:function(e,s,i){var n=this;if("object"===t(e)){if(s||i)throw"bad arguments, see API docs";var a=e;Object.keys(a).forEach(function(e){var s=e,i=a[s];if("object"!==t(i))throw"bad arguments, see API docs";var r=n._metaframes[s];null!=r?r.setInputs(i):n.error("No iframe id=$metaframeId")})}else{if("string"!=typeof e)throw"bad arguments, see API docs";var r=this._metaframes[e];if(null==r&&this.error("No iframe id=".concat(e)),"string"==typeof s)r.setInput(s,i);else{if("object"!==t(s))throw"bad arguments, see API docs";r.setInputs(s)}}}},{key:"setInputs",value:function(t,e,s){this.setInput(t,e,s)}},{key:"setOutputStateOnly",value:function(t,e,s){this._setStateOnly(!1,t,e,s)}},{key:"setInputStateOnly",value:function(t,e,s){this._setStateOnly(!0,t,e,s)}},{key:"_setStateOnly",value:function(e,s,i,n){var a=this;if("object"===t(s)){if(i||n)throw"If first argument is an object, subsequent args should be undefined";var r=s;Object.keys(r).forEach(function(s){var i=r[s];if("object"!==t(i))throw"Object values must be objects";var n=a._metaframes.hasOwnProperty(s);if(!n&&!a._plugins.hasOwnProperty(s))throw"No metaframe or plugin: ${metaframeId}";var u=n?e?a._state.metaframes.inputs:a._state.metaframes.outputs:e?a._state.plugins.inputs:a._state.plugins.outputs;u[s]=null!=u[s]?u[s]:{},Object.keys(i).forEach(function(t){void 0===i[t]?delete u[s][t]:u[s][t]=i[t]})})}else{if("string"!=typeof s)throw"First argument must be a string or an object";var u=s,o=this._metaframes.hasOwnProperty(u);if(!o&&!this._plugins.hasOwnProperty(u))throw"No metaframe or plugin: ".concat(u);var l=o?e?this._state.metaframes.inputs:this._state.metaframes.outputs:e?this._state.plugins.inputs:this._state.plugins.outputs;if("string"==typeof i){l[u]=null!=l[u]?l[u]:{};var f=i;void 0===n?delete l[u][f]:l[u][f]=n}else{if("object"!==t(i))throw"Second argument must be a string or an object";l[u]=null!=l[u]?l[u]:{};var c=i;Object.keys(c).forEach(function(t){void 0===c[t]?delete l[u][t]:l[u][t]=c[t]})}}}},{key:"getMetaframeOrPlugin",value:function(t){var e=this._metaframes[t];return e||(e=this._plugins[t]),e}},{key:"onMessage",value:function(e){var s=this;if("object"===t(e.data)){var i=e.data;if(!this.isValidJSONRpcMessage(i))return void(this.debug&&this.log("invalid message ".concat(JSON.stringify(i).substr(0,200))));var n=i.method;switch(n){case m.JsonRpcMethodsFromChild.SetupIframeClientRequest:Object.keys(this._metaframes).forEach(function(t){s._metaframes[t].register()}),Object.keys(this._plugins).forEach(function(t){s._plugins[t].register()});break;case m.JsonRpcMethodsFromChild.SetupIframeServerResponseAck:var a=i.params;this.getMetaframeOrPlugin(i.iframeId).registered(a.version);break;case m.JsonRpcMethodsFromChild.OutputsUpdate:var r=i.iframeId,u=i.params;if(this.debug&&this.log("outputs ".concat(u," from ").concat(r)),this._metaframes[r]){var o=this._metaframes[r];this.setOutputStateOnly(r,u),o.setOutputs(u),this.emit(g.State,this._state);var l=!1;Object.keys(u).forEach(function(t){var e=s.getInputsFromOutput(r,t);e.length>0&&Object.keys(e).forEach(function(i){var n=e[i],a={};a[n.pipe]=u[t],s.setInputStateOnly(n.metaframe,n.pipe,u[t]),s._metaframes[n.metaframe].setInputs(a),l=!0})}),l&&this.emit(g.State,this._state),this.debug&&o.ack({jsonrpc:i,state:this._state})}else if(this._plugins[r]){var f=!u[c.METAPAGE_KEY_STATE]&&!u[c.METAPAGE_KEY_DEFINITION];f&&this.setOutputStateOnly(r,u),this._plugins[r].setOutputs(u),f&&this.emit(g.State,this._state),this.debug&&this._plugins[r].ack({jsonrpc:i,state:this._state})}else this.error("missing metaframe/plugin=$metaframeId");case m.JsonRpcMethodsFromChild.InputsUpdate:r=i.iframeId;var h=i.params;if(this.debug&&this.log("inputs ".concat(h," from ").concat(r)),this._metaframes[r]){switch(this.setInputStateOnly(r,h),this._metaframes[r].version){case p.Versions.V0_0_1:case p.Versions.V0_1_0:if(this._metaframes[r].emit(g.Inputs,h),this.isListeners(g.Inputs)){var d={};d[r]=h,this.emit(g.Inputs,d)}break;default:this._metaframes[r].setInputs(h)}this.emit(g.State,this._state),this.debug&&this._metaframes[r].ack({jsonrpc:i,state:this._state})}else if(this._plugins[r]){var _=!h[c.METAPAGE_KEY_STATE]&&!h[c.METAPAGE_KEY_DEFINITION];_&&this.setInputStateOnly(r,h),this._plugins[r].setInputs(h),_&&this.emit(g.State,this._state),this.debug&&this._plugins[r].ack({jsonrpc:i,state:this._state})}else console.error('InputsUpdate failed no metaframe or plugin id: "'.concat(r,'"')),this.error('InputsUpdate failed no metaframe or plugin id: "'.concat(r,'"'));case m.JsonRpcMethodsFromChild.PluginRequest:var v=i.iframeId;null!=this._plugins[v]&&this._plugins[v].hasPermissionsState()&&(this._plugins[v].setInput(c.METAPAGE_KEY_STATE,this._state),this.debug&&this._plugins[v].ack({jsonrpc:i,state:this._state}));default:this.debug&&this.log('Unknown RPC method: "'.concat(n,'"'))}this.emit(m.OtherEvents.Message,i)}}},{key:"logInternal",value:function(t,e,s){var i;s=null!=s?s:this._consoleBackgroundColor,i="string"==typeof t?t:"number"==typeof t?t+"":JSON.stringify(t),i=null!=this._id?"Metapage[".concat(this._id,"] ").concat(i):i,d.log(i,e,s)}}],[{key:"from",value:function(t,e){if(null==t)throw"Metapage definition cannot be null";if("string"==typeof t)try{t=JSON.parse(t)}catch(s){throw"Cannot parse into JSON:\n${metaPageDef}"}return(new _).setDefinition(t)}}]),_}()),I.version=c.VERSION,I.DEFINITION=g.Definition,I.INPUTS=g.Inputs,I.OUTPUTS=g.Outputs,I.STATE=g.State,I.ERROR=g.Error,b=function(t){r(a,u.EventEmitter);var s=o(a);function a(t,i,n,r){var u,o=arguments.length>4&&void 0!==arguments[4]&&arguments[4];if(e(this,a),(u=s.call(this)).inputs={},u.outputs={},u._disposables=[],u._rpcListeners=[],u._loaded=!1,u._onLoaded=[],u._sendInputsAfterRegistration=!1,u._cachedEventInputsUpdate={iframeId:null,inputs:null},u._cachedEventOutputsUpdate={iframeId:null,inputs:null},!t.startsWith("http")){for(;t.startsWith("/");)t=t.substr(1);t=location.protocol+"//"+location.hostname+(null!=location.port&&""!=location.port?":"+location.port:"")+"/"+t}u.url=t;var l=new URL(u.url);return o&&l.searchParams.set(c.URL_PARAM_DEBUG,"1"),u.url=l.href,u.id=i,u.iframe=document.createElement("iframe"),u.iframe.src=u.url,u._debug=o||d.existsAnyUrlParam(["DEBUG_METAFRAMES","debug_metaframes","debug_"+u.id,"DEBUG_"+u.id]),u.iframe.frameBorder="0",u._parentId=n,u._color=d.stringToRgb(u.id),u._consoleBackgroundColor=r,u}return i(a,[{key:"setPlugin",value:function(){if(this._loaded)throw"Cannot setPlugin after IFrameRpcClient already loaded";return this._plugin=!0,this.bindPlugin(),this}},{key:"setMetapage",value:function(t){return this._metapage=t,this}},{key:"bindPlugin",value:function(){return k(this,void 0,void 0,regeneratorRuntime.mark(function t(){var e,s,i,n=this;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,this.getDefinition();case 3:e=t.sent,this.hasPermissionsDefinition()&&(s=this._metapage.addEventListener(g.Definition,function(t){n.setInput(c.METAPAGE_KEY_DEFINITION,t.definition)}),this._disposables.push(s),i=this._metapage.getDefinition(),this.setInput(c.METAPAGE_KEY_DEFINITION,i),e.outputs&&(s=this.onOutput(c.METAPAGE_KEY_DEFINITION,function(t){n._metapage.setDefinition(t)}),this._disposables.push(s))),this.hasPermissionsState()&&null!=e.outputs&&(s=this.onOutput(c.METAPAGE_KEY_STATE,function(t){n._metapage.setState(t)}),this._disposables.push(s)),t.next=11;break;case 8:t.prev=8,t.t0=t.catch(0),this._metapage.emit(g.Error,'Failed to get plugin definition from "'.concat(this.getDefinitionUrl(),'", error=').concat(t.t0));case 11:case"end":return t.stop()}},t,this,[[0,8]])}))}},{key:"hasPermissionsState",value:function(){return null!=this._definition&&null!=this._definition.inputs[c.METAPAGE_KEY_STATE]}},{key:"hasPermissionsDefinition",value:function(){return null!=this._definition&&null!=this._definition.inputs[c.METAPAGE_KEY_DEFINITION]}},{key:"getDefinitionUrl",value:function(){var t=new URL(this.url);return t.pathname=t.pathname+(t.pathname.endsWith("/")?"metaframe.json":"/metaframe.json"),t.href}},{key:"getDefinition",value:function(){return k(this,void 0,void 0,regeneratorRuntime.mark(function t(){var e,s,i;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(null==this._definition){t.next=2;break}return t.abrupt("return",this._definition);case 2:return e=this.getDefinitionUrl(),t.next=5,window.fetch(e);case 5:return s=t.sent,t.next=8,s.json();case 8:return i=t.sent,this._definition=i,t.abrupt("return",i);case 11:case"end":return t.stop()}},t,this)}))}},{key:"setInput",value:function(t,e){console.assert(null!=t);var s={};s.set(t,e),this.setInputs(s)}},{key:"setInputs",value:function(t){if(!this.inputs.merge(t))return this;if(this._loaded||(this._sendInputsAfterRegistration=!0),null!=this.iframe.parentNode&&this._loaded&&this.sendInputs(t),this.emit(g.Inputs,this.inputs),this._metapage.isListeners(g.Inputs)){var e={};e[this.id]=t,this._metapage.emit(g.Inputs,e)}return this._cachedEventInputsUpdate.iframeId=this.id,this._cachedEventInputsUpdate.inputs=this.inputs,this._metapage.emit(m.JsonRpcMethodsFromParent.InputsUpdate,this._cachedEventInputsUpdate),this}},{key:"setOutput",value:function(t,e){console.assert(null!=t);var s={};s.set(t,e),this.setOutputs(s)}},{key:"setOutputs",value:function(t){if(this.outputs.merge(t)&&(this.emit(g.Outputs,t),this._metapage.isListeners(g.Outputs))){var e={};e[this.id]=this.outputs,this._metapage.emit(g.Outputs,e)}}},{key:"onInputs",value:function(t){return this.on(g.Inputs,t)}},{key:"onInput",value:function(t,e){return this.on(g.Inputs,function(s){s.exists(t)&&e(s[t])})}},{key:"onOutputs",value:function(t){return this.on(g.Outputs,t)}},{key:"onOutput",value:function(t,e){return this.on(g.Outputs,function(s){s.exists(t)&&e(s[t])})}},{key:"dispose",value:function(){for(n(h(a.prototype),"dispose",this).call(this);null!=this._disposables&&this._disposables.length>0;)this._disposables.pop()();this._rpcListeners=null,this.inputs=null,this.outputs=null,this._ready=null,null!=this.iframe&&null!=this.iframe.parentNode&&this.iframe.parentNode.removeChild(this.iframe),this.iframe=null,this._bufferMessages=null,null!=this._bufferTimeout&&(window.clearInterval(this._bufferTimeout),this._bufferTimeout=null),this._metapage=null}},{key:"register",value:function(){if(!this._loaded){var t={iframeId:this.id,parentId:this._parentId,plugin:this._plugin,state:{inputs:this.inputs},version:I.version};this.sendRpcInternal(m.JsonRpcMethodsFromParent.SetupIframeServerResponse,t)}}},{key:"registered",value:function(t){if(!this._loaded){for(this.version=t,null==this.version&&(this.version=p.Versions.V0_1_0),this._loaded=!0;null!=this._onLoaded&&this._onLoaded.length>0;)this._onLoaded.pop()();this._sendInputsAfterRegistration&&this.sendInputs(this.inputs)}}},{key:"sendInputs",value:function(t){this.sendRpc(m.JsonRpcMethodsFromParent.InputsUpdate,{inputs:t,parentId:this._parentId})}},{key:"sendRpc",value:function(t,e){null!=this.iframe.parentNode&&this._loaded?this.sendRpcInternal(t,e):(this._metapage.error("sending rpc later"),this._onLoaded.push(function(){this.sendRpcInternal(t,e)}))}},{key:"ack",value:function(t){if(this.log("⚒ ⚒ ⚒ calling ack"),this._debug){this.log("⚒ ⚒ ⚒ sending ack from client to frame");var e={message:t};this.sendRpc(m.JsonRpcMethodsFromParent.MessageAck,e)}else this.log("⚒ ⚒ ⚒ NOT sending ack from client to frame since not debug mode")}},{key:"log",value:function(t){this._debug&&this.logInternal(t)}},{key:"logInternal",value:function(t){var e;e="string"==typeof t?t:"string"==typeof t?t+"":JSON.stringify(t),d.log("Metapage[".concat(this._parentId,"] Metaframe[$id] ").concat(e),this._color,this._consoleBackgroundColor)}},{key:"sendRpcInternal",value:function(t,e){var s={id:"_",iframeId:this.id,jsonrpc:"2.0",method:t,params:e,parentId:this._parentId};null!=this.iframe?this.sendOrBufferPostMessage(s):this._metapage.error("Cannot send to child iframe messageJSON=${JSON.stringify(messageJSON).substr(0, 200)}")}},{key:"sendOrBufferPostMessage",value:function(t){null!=this.iframe.contentWindow?this.iframe.contentWindow.postMessage(t,this.url):null==this._bufferMessages?(this._bufferMessages=[t],this._bufferTimeout=window.setInterval(function(){var t=this;null!=this.iframe.contentWindow&&(this._bufferMessages.forEach(function(e){return t.iframe.contentWindow.postMessage(e,t.url)}),window.clearInterval(this._bufferTimeout),this._bufferTimeout=null,this._bufferMessages=null)},0)):this._bufferMessages.push(t)}}]),a}()}}});
},{}]},{},["Vntl"], null)
//# sourceMappingURL=/Metapage.js.map