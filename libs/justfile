# https://github.com/casey/just
# Build the npm libraries: metapage, metaframe

parcel          := "node_modules/parcel-bundler/bin/cli.js"

# When developing, watch+build the libs in the following dir
# as e.g. docs/js/Metapage.js. This is served by jekyll and 
# runs the tests. Will move this docs dependency soon.
dev_out_dir     := "test/page/js/"

help:
    @just --list

# TODO: remove the jekyll dependency, and just create a static page to serve
# Run tests, expects jekyll running to serve the page
test:
	# node test/test.js

generate:
	#!/usr/bin/env node
	console.log('sfsf')

# Build the production distributions in build/metaframe and build/metapage
build: clean
	{{parcel}} build ts/metapage/client/Metaframe.ts --out-dir build/metaframe
	{{parcel}} build ts/metapage/client/Metapage.ts --out-dir build/metapage

	@# copy production builds to the (dev+docs+test) dir
	cp -r build/metaframe/* ../docs/js/
	cp -r build/metapage/* ../docs/js/
	cp -r build/metapage/Metapage* test/page/js/
	cp -r build/metapage/Metaframe* test/page/js/


# watch for file changes, building on change.
watch out="{{dev_out_dir}}": clean
    {{parcel}} watch ts/metapage/client/Metaframe.ts ts/metapage/client/Metapage.ts --out-dir {{out}}

@clean:
	rm -rf ../docs/js/Metapage*
	rm -rf ../docs/js/Metaframe*
	rm -rf test/page/js/Metapage*
	rm -rf test/page/js/Metaframe*

# Write library versions to the place where jekyll can consume:
# docs/_data/versions.yml
_versions-write-versions-to-jekyll:
	#!/usr/bin/env node
	var lib = require(process.cwd() + '/test/lib.js');
	var fs = require('fs');
	var p = lib.getMetapageVersions(true);
	p.then((versions) => { var out = 'versions: ' + JSON.stringify(versions); console.log('./docs/_data/versions.yml:\n' + out + '\n'); fs.writeFileSync('/docs/_data/versions.yml', out + '\n')});
